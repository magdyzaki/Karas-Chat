# لماذا لا يعمل التنبيه عند إطفاء الشاشة؟ وكيف تتحقق؟

---

## سبب محتمل: فقدان البيانات عند إعادة تشغيل السيرفر

على Koyeb (الخطة المجانية)، قاعدة البيانات تُحفظ في **مجلد مؤقت** داخل الحاوية. عند **إعادة تشغيل** الحاوية أو **استيقاظها من النوم** (بعد Scale to Zero)، قد تُشغَّل حاوية **جديدة** بمجلد مؤقت **فارغ**. النتيجة:

- لا مستخدمين، لا تنبيهات، لا اشتراكات Push محفوظة.
- حتى لو الكرون يضرب `/api/push/check` ويوقظ السيرفر، الفحص لا يجد تنبيهات ولا اشتراكات فيُرسل لا شيء.

لذلك قد يعمل التنبيه **فقط** إذا:
- أضفت تنبيهاً وسمحت بالإشعارات ثم **أطفأت الشاشة فوراً**،
- ووصل موعد التنبيه **قبل** أن تنام الحاوية (مثلاً خلال 5 دقائق)،
- والكرون يضرب الرابط في نفس هذه الفترة فيُشغّل الفحص على نفس الحاوية التي فيها بياناتك.

إذا نامت الحاوية ثم استيقظت حاوية جديدة، البيانات تُفقد والتنبيه لا يصل.

---

## كيف تتحقق من السيرفر؟

بعد أن تضبط **CRON_SECRET** في Koyeb وتعرِف قيمته، يمكنك فتح هذا الرابط من المتصفح (واستبدل `كلمة_السر` بقيمة CRON_SECRET):

```
https://southern-winonah-elraee-ae4bfbd7.koyeb.app/api/push/status?secret=كلمة_السر
```

يفترض أن ترى رداً مثل:

```json
{
  "ok": true,
  "push_subscriptions_count": 1,
  "reminders_count": 1,
  "due_not_notified_count": 0,
  "vapid_set": true
}
```

- **push_subscriptions_count:** عدد الاشتراكات المحفوظة. إذا كان **0** فالتطبيق لم ينجح في حفظ الاشتراك (مثلاً VAPID غير مضبوط أو صلاحية الإشعارات مرفوضة).
- **reminders_count:** عدد التنبيهات. إذا كان **0** فإما لم تُضف تنبيهاً أو البيانات فُقدت بعد إعادة تشغيل.
- **due_not_notified_count:** تنبيهات مستحقة ولم تُرسل بعد. عند الموعد يرتفع ثم بعد إرسال Push يعود إلى 0.
- **vapid_set:** إذا كان **true** فمفاتيح VAPID مضبوطة على السيرفر.

إذا كان **push_subscriptions_count = 0** أو **reminders_count = 0** رغم أنك سجّلت وأضفت تنبيهاً وسمحت بالإشعارات، فغالباً إما البيانات فُقدت (حاوية جديدة) أو الاشتراك فشل (تحقق من VAPID والإشعارات).

---

## ما الذي تحتاج رفعه للتشخيص؟

- في الباكند: **index.js** (فيه مسار `/api/push/check` ومسار `/api/push/status`) و **db.js** (فيه دالة `getStats`).
- بعد الرفع على GitHub وعمل Redeploy على Koyeb، جرّب رابط `/api/push/status?secret=...` كما أعلاه.

---

## وصف الواجهة للتأكد

للتأكد أنك على النسخة الصحيحة من الواجهة، راجع الملف **وصف-الواجهة-للتأكد.md** — فيه وصف لما يجب أن يظهر على الشاشة (نسخة واجهة: 2، حالة التنبيه مع الشاشة مطفية، أزرار إعادة المحاولة وتجربة تنبيه الآن، إلخ).
