# السبب الحقيقي لعدم عمل التنبيه عند إطفاء الشاشة — والحل

---

## السبب الحقيقي

على **Koyeb** (والخطة المجانية عادة)، الخدمة تدخل في وضع **النوم (Scale to Zero)** بعد فترة بدون زيارات. عند النوم:

- السيرفر يتوقف أو يُجمّد.
- الـ **setInterval** الذي يتحقق كل دقيقة من المواعيد **يتوقف**.
- لذلك عند موعد التنبيه **لا يوجد من يرسل إشعار الدفع (Push)**.

أيضاً تم تحسين تنسيق **keys** الاشتراك عند الإرسال حتى لا يفشل الإرسال بسبب اختلاف في الحروف (p256dh / auth).

---

## الحل: كرون خارجي يوقظ السيرفر ويفحص التنبيهات

تم إضافة مسار على الباكند:

**GET**  
`https://southern-winonah-elraee-ae4bfbd7.koyeb.app/api/push/check?secret=كلمة_سرك`

عند استدعاء هذا الرابط يتم فحص التنبيهات المستحقة وإرسال Push للمشتركين. إذا كان السيرفر نائماً، الطلب يوقظه ثم ينفّذ الفحص.

---

## خطوات التفعيل (مرة واحدة)

### 1) إضافة متغير في Koyeb

1. ادخل **Koyeb** → خدمة **reminders-backend** → **Settings** → **Environment**.
2. أضف متغيراً جديداً:
   - **Name:** `CRON_SECRET`
   - **Value:** كلمة سر طويلة (مثلاً سلسلة عشوائية مثل: `MyCronSecret2026Reminders`)
3. احفظ ثم اعمل **Redeploy** (حتى يقرأ السيرفر المتغير الجديد).

### 2) إعداد كرون مجاني يضرب الرابط كل دقيقة

1. ادخل **cron-job.org** (أو أي خدمة كرون مجانية).
2. سجّل دخول أو أنشئ حساباً.
3. أنشئ مهمة جديدة:
   - **Title:** مثلاً Reminders Push Check
   - **URL:**  
     `https://southern-winonah-elraee-ae4bfbd7.koyeb.app/api/push/check?secret=كلمة_سرك`  
     (استبدل `كلمة_سرك` بنفس قيمة **CRON_SECRET** التي وضعتها في Koyeb)
   - **Interval:** كل **1 دقيقة** (أو 2 دقائق إذا الخدمة لا تدعم دقيقة واحدة).
4. احفظ المهمة.

بعد ذلك سيتم استدعاء الرابط كل دقيقة؛ السيرفر يستيقظ (إن كان نائماً) ويشغّل فحص التنبيهات ويرسل Push للمشتركين.

---

## ملخص

| المشكلة | السبب | الحل |
|--------|--------|------|
| التنبيه لا يعمل والشاشة مطفية | السيرفر ينام (Scale to Zero) فيتوقف setInterval | كرون خارجي يطلب `/api/push/check?secret=...` كل دقيقة |
| احتمال فشل إرسال Push | اختلاف في تنسيق keys الاشتراك | تم تطبيع تنسيق p256dh و auth في الكود |

بعد ضبط **CRON_SECRET** في Koyeb وإعداد الكرون على cron-job.org، جرّب: أضف تنبيهاً بعد دقيقتين، اطفئ الشاشة، وانتظر حتى بعد الموعد بدقيقة — يفترض أن يصل الإشعار.
