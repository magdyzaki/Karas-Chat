# إصلاح «registration failed - push service error» على أندرويد

هذا الخطأ يظهر أحياناً عندما Chrome على أندرويد لا يستطيع التسجيل في خدمة الإشعارات (FCM). الأسباب الشائعة: **مفتاح VAPID فيه مسافات أو أسطر**، أو **اشتراك/Service Worker قديم**.

---

## 1) مسح بيانات الموقع على الموبايل

1. في **Chrome** على الموبايل ادخل: **reminders-frontend.vercel.app**
2. اضغط أيقونة **القفل** أو **ⓘ** بجانب الرابط.
3. اختر **إعدادات الموقع** ثم **مسح البيانات المحفوظة** أو **Clear & reset**.
4. أكد المسح ثم **أعد فتح** الرابط، سجّل الدخول واضغط **«إعادة المحاولة»**.

---

## 2) التأكد من مفتاح VAPID في Koyeb (بدون مسافات أو أسطر)

1. ادخل **Koyeb** → خدمتك **reminders-backend** → **Settings** → **Environment**.
2. افتح **VAPID_PUBLIC_KEY** للتعديل.
3. تأكد أن القيمة **سطر واحد فقط**، بدون مسافة في البداية أو النهاية، و**بدون أسطر جديدة** في المنتصف. احذف أي مسافات زائدة أو أسطر ثم احفظ.
4. نفس الشيء لـ **VAPID_PRIVATE_KEY**: سطر واحد فقط، بدون مسافات أو أسطر زائدة.
5. احفظ ثم اعمل **Redeploy** (مع Create build).

---

## 3) إن استمر الخطأ: توليد مفاتيح VAPID جديدة

1. على جهازك من مجلد **reminders-app/backend** شغّل: **npm start**
2. من نافذة الـ Console انسخ السطرين اللذين يبدأان بـ **VAPID_PUBLIC_KEY=** و **VAPID_PRIVATE_KEY=** (انسخ **القيمة فقط**، بدون كلمة "VAPID_PUBLIC_KEY=" أو "VAPID_PRIVATE_KEY=").
3. في **Koyeb** → Environment احذف القيم القديمة لـ **VAPID_PUBLIC_KEY** و **VAPID_PRIVATE_KEY** والصق القيم الجديدة (سطر واحد لكل مفتاح، بدون مسافات أو أسطر).
4. احفظ ثم **Redeploy**.
5. على الموبايل: **امسح بيانات الموقع** كما في (1) ثم أعد فتح الرابط واضغط **«إعادة المحاولة»**.

---

## 4) التعديلات في الكود

تم في الباكند والواجهة:
- إرجاع المفتاح العام **بدون مسافات أو أسطر** من السيرفر.
- في الواجهة تنظيف المفتاح قبل الاستخدام.
- عند ظهور «push service error» تظهر رسالة توجيهية للمستخدم.

بعد رفع التعديلات (ملفات **push.js** و **notifications.js**) ونشرها، جرّب الخطوات (1) و (2) أعلاه؛ إن لم يكفِ فاتبع (3).
