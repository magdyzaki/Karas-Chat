# جعل التنبيه يشتغل مع الشاشة مطفية (التليفون على المكتب)

التطبيق يتحقق من المواعيد فقط عندما الصفحة **مفتوحة**. لو التليفون مغلق أو الصفحة غير مفتوحة، التنبيه لا يصل إلا إذا كان **إشعار الدفع (Push)** مفعّلاً من السيرفر.

---

## ما المطلوب؟

1. **إعادة رفع جميع ملفات الباكند** المحدّثة على GitHub (ليس ملفاً واحداً فقط — المطلوب: `package.json`، `db.js`، `index.js`، `middleware/auth.js`، `routes/auth.js`، `routes/reminders.js`، `routes/push.js`) ثم على **Koyeb** عمل **Redeploy** مع **Create build** حتى يعمل السيرفر الجديد. التفاصيل في **خطوات-إصلاح-Build-وPush.md** داخل `backend`.
2. **مفاتيح VAPID:** إذا كانت **VAPID_PUBLIC_KEY** و **VAPID_PRIVATE_KEY** مسجّلتين مسبقاً في **Koyeb → Settings → Environment** فلا حاجة لإضافتهما مرة أخرى — كده صح. تأكد فقط أن القيم غير محذوفة وأنهما زوج واحد (عام + خاص). إذا لم تكونا موجودتين، شغّل السيرفر محلياً مرة وانسخ المفتاحين من الـ Console ثم أضفهما في Environment.
3. الواجهة الأمامية **تشترك تلقائياً** في Push عند تسجيل الدخول؛ بعد تنفيذ الخطوات أعلاه، عند موعد التنبيه السيرفر يرسل إشعار حتى لو الشاشة مطفية.

---

## شرح: ماذا يعني «الواجهة تشترك تلقائياً في Push عند تسجيل الدخول»؟

- **الاشتراك في Push** = المتصفح يخبر السيرفر: «أرسل لي إشعارات على هذا الجهاز عند موعد التنبيه».
- **تلقائياً** = لا تحتاج تضغط زر «اشترك»؛ الكود يشغّل الاشتراك **بعد أن تسجّل الدخول** مباشرة (مرة واحدة في الجلسة).
- **ماذا يحدث خطوة بخطوة:**
  1. تسجّل الدخول في التطبيق.
  2. الواجهة تطلب من المتصفح صلاحية **الإشعارات** (نافذة «السماح / الحظر»).
  3. لو سمحت، المتصفح يتصل بالسيرفر ويأخذ مفتاحاً عاماً (VAPID).
  4. المتصفح يسجّل «عنوان» خاص به لاستقبال الإشعارات (يُسمّى subscription).
  5. هذا العنوان يُرسل إلى السيرفر ويُحفظ مع حسابك.
  6. لاحقاً، عند موعد أي تنبيه، السيرفر يرسل الإشعار إلى هذا العنوان — فيصل للموبايل حتى لو التطبيق مغلق أو الشاشة مطفية.
- **أنت كمستخدم:** فقط تسجّل الدخول وتسمح بالإشعارات عندما يطلب المتصفح؛ الباقي يتم في الخلفية بدون أي خطوة إضافية منك.

---

**ملخص:** التنبيه مع الشاشة مطفية يعمل فقط بعد نشر الباكند الذي يدعم Push وضبط مفاتيح VAPID على Koyeb.
